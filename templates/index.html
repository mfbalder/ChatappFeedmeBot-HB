
	{% extends "base.html" %}
	{% block body %}

	<div id='online-users'>
		<h4>Connected Users</h4>
		{% if users %}
			<ul>
			{% for user in users %}
				{% if user == 'AskRonnie' %}
				<li><div class='logo' id='ronnielogo'></div><a class='user_link' id='{{ user }}' href='#'>{{ user }}</a></li>
				{% else %}
				<li><div class='logo'></div><a class='user_link' id='{{ user }}' href='#'>{{ user }}</a></li>
				{% endif %}
			{% endfor %}
			</ul>
		{% endif %}
	</div>

	<div id="chat-section">
	</div>



	<script src='//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
	<script type='text/javascript' src='//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js'></script>
	<script src='//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js'></script>
	<script>
	$(document).ready(function() {

		// sets the current user and current room
		var loggedInUser='{{ user }}',
			currentRoom = '';


		// connect the socket
	    var socket = io.connect('http://' + document.domain + ':' + location.port + "/chat");


	    // joins the current user to their own personal room
		socket.emit('join room', 
					{'username':  loggedInUser, 'room':  loggedInUser}
		);

		socket.emit('refresh connected users');

		console.log('The ' +  loggedInUser + ' is being added to room:' +  loggedInUser);

		// when a user's room receives a command
		socket.on('interpret command', function(data) {
			var command = data.command,
				commandBody = data.body,
				commandOrigin = data.origin;

			// if that command is a J (for join), join them to the given room
			if(command === 'J') {
				var newRoom = commandBody;

				socket.emit('join room', 
							{'username':  loggedInUser, 'room': newRoom}
				); 

				$('#chat-box').removeClass('hidden');
				// establish that this new room is the room we're currently talking in
				currentRoom = newRoom
			}

			// if the user receives a UL (update list) command, refresh their list of connected users
			else if(command === 'UL') {
				$('#online-users').load('/refresh_users?user=' +  loggedInUser);
			}

		});

		// when the current user clicks on a connected user
		$(document).on('click', '.user_link', function(event) {
			var userToTalkTo = $(this).attr('id');
			// create a new room name for the two users to share

			if(userToTalkTo <  loggedInUser) {
				var newRoom = userToTalkTo +  loggedInUser;
			} 
			else {
				var newRoom =  loggedInUser + userToTalkTo;
			}


			// send command to userToTalkTo's room
			socket.emit('receive command', 
						{'command': 'J', 'body':newRoom, 'room': userToTalkTo}
			);
			// send command to  loggedInUser's room
			socket.emit('receive command', 
						{'command': 'J', 'body':newRoom, 'room':  loggedInUser}
			);
			socket.emit('open chat', 
						{'submitting':  loggedInUser, 'receiving': userToTalkTo, 'room': newRoom}
			);

		});

		socket.on('open chat box', function(event) {
			console.log(event);
			if($('#' + event.chat_room).length === 0) {
				console.log("The chatroom doesn't exist yet, add it");
				var html = event.template;
				$('#chat-section').append(html);
			}
			else {
				console.log("The chatroom already exists. Don't add it");
			}
			return false;
		});

		$(document).on('submit', 'form', function(event) {
			event.preventDefault();
			var _this = $(this),
				chat_room = _this.parent('.chat-box').attr('id'),
				message = _this.find('input[name="message"]').val(),
				ronnie = new RegExp('AskRonnie');

			if(ronnie.test(chat_room)) {
				var $log = $('.log');

				$('#' + chat_room + ' div.log').append('<p class="self-color">' +  loggedInUser + ': ' + message + '</p>');
	    		$log.scrollTop($log[0].scrollHeight);
	    		socket.emit('talk to ronnie', 
	    					{'message': message, 'room': chat_room}
	    		);
			}
			else {
				socket.emit('message event', 
							{data: message, 'room': chat_room}
				);
			}
			_this.find('input[name="message"]').val('');
		});

		// if the user closes the window, remove it from their DOM
		$(document).on('click', '.end-chat', function(event) {
			var _this = $(this);

			// send a message telling the other user that the chat has been exited
			socket.emit('message event', 
						{data:  loggedInUser + ' has left the chat.', 'room': _this.parent('.chat-box').attr('id')}
			);
			_this.parent('.chat-box').remove();
			// remove the user from that joint room
		});


	    // when the client gets that message back from the server,
	    // display it in the log
	    socket.on('message to display', function(response) {
	    	var chatRoom = response.room,
	    		$log = $('.log'),
	    		$chatRoomLog = $('#' + chatRoom + ' div.log');
	    	// console.log($("#" + chat_room + " div.log"));
	    	if(response.user ===  loggedInUser) {
	    		$chatRoomLog.append('<p class="self-color">' + response.user + ': ' + response.message + '</p>');
	    		$log.scrollTop($log[0].scrollHeight);
	    	}
	    	else {
	    		$chatRoomLog.append('<p class="other-color">' + response.user + ': ' + response.message + '</p>');
	    		$log.scrollTop($log[0].scrollHeight);
	    	}
	    	// $("#" + chatRoom + " div.log").append('<p>' + response.user + ': ' + response.message + '</p>');
	    	
	    });

	    socket.on('app message display', function(response) {
	    	var chatRoom = response.room,
	    		$log = $('.log'),
	    		$chatRoomLog = $('#' + chatRoom + ' div.log');

	    	$chatRoomLog.append('<p>' + response.message + '</p>');
	    	$log.scrollTop($log[0].scrollHeight);
	    });

		// when a user logs out, tell all users to fresh their conencted list
		$(document).on('click', '#logout', function(event) {
			socket.emit('refresh connected users');			
		});

		$(document).on('click', '.get_phone', function(event) {
			event.preventDefault();
			num = prompt('Please enter your phone number', '(xxx)xxx-xxxx')
			var href = $(this).attr('href') + num;
			console.log(href);
			$.get(href);
		});


		$(document).on('mousedown', '.button-style', function(event) {
			$(this).css('backgroundColor', 'lightGrey');
		});

		$(document).on('mouseup', '.button-style', function(event) {
			$(this).css('backgroundColor', 'gray');
		});

		$(document).on('focusout', '.chat-box', function(event) {
			$(this).addClass('blurred');
		});

		$(document).on('focusin', '.chat-box', function(event) {
			$(this).removeClass('blurred');
		});
	


	});
	</script>

	{% endblock %}

